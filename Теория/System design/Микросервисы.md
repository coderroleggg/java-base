# Как работать с микросервисами на реальных проектах? Мой опыт

Почти все разработчики любят внедрять "крутые" технические решения.
Однако с любыми резкими мувами на большом проекте нужно быть аккуратнее. Перед совершением каждого шага по изменению существующей архитектуры нужно тщательно продумать причины и риски совершаемого действия.

Одним из популярных технических решений является переписывание монолита на микросервисы. В этом посте предлагаю погрузиться в тему микросервисов и хотя бы частично разобрать логику, по которой стоит (на мой взгляд) действовать, если ты хочешь прикоснуться к микросервисам. В основе поста мысли во время ретро, реальные баги с прода и выводы после долгих обсуждений с коллегами!

## Что такое микросервисы?

Микросервисная архитектура - это подход к разработке, при котором приложение строится как набор небольших сервисов, каждый из которых:

- Выполняет одну бизнес-функцию
- Работает независимо
- Взаимодействует с другими сервисами через API

## Зачем использовать микросервисы?

- Чтобы независимо масштабировать части системы
- Чтобы релизить разные сервисы независимо друг от друга
- Чтобы упростить код, разделив его на независимые части

## В какой момент стоит начать делить монолит на микросервисы?

Когда в твоем сервисе уже есть проблемы из списка:

- Слишком много изменений в одном сервисе разрабатываются параллельно. Возникают проблемы с тем, что непротестированные фичи блокируют релиз готовых задач.

- Сервису не хватает вычислительных ресурсов/памяти. И при этом есть самый жирный процесс внутри сервиса, который и забирает на себя почти все эти ресурсы, а остальные процессы не настолько требовательны.

- Код сервиса стал слишком сложным, что возникают проблемы при реализации новых задач. Любые изменения в одном бизнес-процессе могут случайно иметь неожиданные последствия в других бизнес-процессах.

## Какой размер сервиса оптимален?

Такой, при котором сервис будет решать одну бизнес-задачу. Нет смысла делить слишком мелко. 

Например, сервис для форматирования телефонов будет слишком маленьким. При таком делении, сервис не будет решать проблемы:

- Изменения в нем будут происходить очень-очень редко (так как логика очень мелкая)

- Масштабировать такой сервис независимо от других не понадобится, так как он не будет выполнять отдельную бизнес-функцию. Он будет масштабироваться всегда в связке с другими сервисами

- Код вызывающего его сервиса не упростится, так как простая валидация телефонов напрямую в большом сервисе заменится на простой вызов API сервиса валидации телефонов

Однако такой сервис будет создавать дополнительные риски:

- Разрыв соединения между сервисами
- Недоступность сервиса

Как организовать взаимодействие между сервисами?

- Синхронное. Если тебе нужно получить мгновенный результат операции, то по-умолчанию используй REST. Использование других протоколов должно быть оправдано спецификой конкретной задачи. Лучше не брать, например, какой-нибудь gRPC просто потому что хочется.

- Асинхронное. Если результат прямо сейчас не нужен. В больших компаниях любят использовать Apache Kafka. Ее знание может быть полезно на собесах

Что нужно поднять по инфраструктуре?

- Логи: ELK/Graylog/Splunk. Без логов твои сервисы будут черным ящиком, невозможно будет понимать что происходит внутри. Желательно уметь работать с какой-нибудь системой логов, чтобы быстро разбирать баги и мониторить ошибки.

- Мониторинг: Prometheus + Grafana. Метрики позволяют отслеживать как технические, так и бизнес значения по времени. Также на метриках можно удобно настроить алерты, которые разбудят тебя ночью, если сервис упал.

- Трейсинг. Еще один способ капнуть глубже и узнать что конкретно и в какой цепочке вызывается внутри твоего сервиса. Но, если честно, я не особо часто использую это в реальной работе.

- CI/CD: Jenkins/GitLab + K8s. Автоматизации и пайплайны позволяют быстро и удобно катить версии на тестовые и продакшн контуры. Если не было опыта написания таких, то можно потренироваться, настроив свои пайпы для пет-проекта через Github Actions

## [Чеклисты по разделению на микросервисы](./Микросервисы%20чеклисты.md)